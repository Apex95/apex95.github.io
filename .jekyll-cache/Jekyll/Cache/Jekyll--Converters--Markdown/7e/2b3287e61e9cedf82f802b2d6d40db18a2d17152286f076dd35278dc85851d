I"r7<p>All right, people; now that I’m done with the projects &amp; finals for…a couple of days…I thought it would be a good idea
to keep an old promise and finally publish this article too. It’s about how to make a <strong>neural network</strong> that learns to play a simple game (<strong>Flappy Bird</strong> in this case) - and training it with a <strong>genetic algorithm</strong>.
This way, maybe, I won’t have to answer any more comments on YouTube…</p>

<p>Btw, here’s a short demo:</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/UmDeboEOIfM" frameborder="0" allowfullscreen=""></iframe>

<p>Hopefully I can still understand the code that I wrote ~7 months ago. Yep.</p>

<h5 id="this-was-my-first-project-that-involved-this-kind-of-stuffthe-code-is-rather-sketchy-and-i-dont-really-have-the-time-to-rewrite-it---probably-better-than-nothing-butsorry-the-encoding--decoding-parts-can-be-skipped---however-the-most-important-part-is-to-grasp-the-idea-behind-it-cant-say-i-really-recommend-implementing-your-own-gas">this was my first project that involved this kind of stuff…the code is rather sketchy and I don’t really have the time to rewrite it - probably better than nothing but…sorry. The encoding / decoding parts can be skipped - however the most important part is to grasp the idea behind it. Can’t say I really recommend implementing your own GA’s.</h5>

<h2 id="basics">Basics</h2>

<p>Well, to better understand this concept, a good starting point is to think of how you play this game: what are the <u>factors</u> that you take into account?
How do you know when the bird should jump?</p>

<p>Pretty sure you are probably using a set of metrics like the following ones:</p>

<ul>
  <li>horizontal distance between the bird and the closest set of pipes (<strong>dist1</strong>)</li>
  <li>vertical distance between the bird and the lower pipe (<strong>dist2</strong>)</li>
  <li>verctical distance between the bird and the upper pipe (<strong>dist3</strong>)</li>
</ul>

<figure class="image">
  <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-echo="/imgs/posts/c-making-a-neural-network-that-plays-flappy-bird/1.png" alt="Metrics used as Inputs for the Neural Network" />
  <figcaption><p>Metrics used as Inputs for the Neural Network</p>
</figcaption>
</figure>

<p>What we actually want now is a <strong>function</strong> that takes these <strong>3 parameters</strong> and has <strong>1 output</strong> (because the whole game can be resumed to a single command).</p>

<script type="math/tex; mode=display">% <![CDATA[
f(dist_1, dist_2, dist_3) = \left\{\begin{matrix}
> 0.5 => jump()\\ 
<= 0.5 => do\_nothing
\end{matrix}\right. %]]></script>

<p>Considering we don’t know the relationship between the 3 distances, we can try to approximate the behaviour of this function using a <strong>neural network</strong>.</p>

<p>In my project I used a network with:</p>

<ul>
  <li>3 input neurons</li>
  <li>2 hidden ones</li>
  <li>1 output neuron.</li>
</ul>

<hr />
<p>I’m going to presume you know the basics of multilayer neural networks - especially the forward propagation (y’know, that part where you multiply each input with the corresponding weight, then sum all of this and pass it to
an activation function…and the result gets fed as an input to a neuron from the next layer). I’m using the matrix version in this code because it looks a little bit more “elegant”, but it’s the same formula, ok?</p>

<h2 id="the-training-part">The training part</h2>

<p>Ehm…this is tricky. We don’t have a training set - so…we can’t use the traditional <strong>gradient descent</strong> (we don’t know the derivatives of the error function) for our neural network.</p>

<p>The alternative is to empirically find a set of <strong>weights</strong> using a <strong>genetic algorithm</strong>. Basically you start with a generation of birds which are rather…dumb
(they will either spam the jump command or not jump at all) - because the weights used by their neural networks are initially some random values. The goal is to simulate the evolutionary process
(survival of the fittest) so you’ll obtain a generation of birds that will jump perfectly each time.</p>

<p><u>Here are the steps:</u></p>

<ol>
  <li>Start with N sets of random weights (that means N different networks) - this would be the first generation.</li>
  <li>Allow each network to play until the bird hits a pipe and save the <strong>scores</strong></li>
  <li>Keep only the sets of weights that performed better than the others (first M from a list ordered by score) - these will make it to the next generation. Also keep the solutions with the highest score (this is called <strong>elitism</strong>, btw. - it’s needed because you may not know if your new solutions are better than the old ones)</li>
  <li>Pick 2 sets from the new population of weights, <strong>encode</strong> them, apply <strong>crossover</strong> (also <strong>mutation</strong>) and then <strong>decode</strong>. Save the results and add them to the new generation too.</li>
  <li>Go back to step 2 and repeat until you get decent results.</li>
</ol>

<h2 id="fitness-function">Fitness function</h2>

<p>Now let’s talk a bit about the function that assigns the score; it’s quite an important part too, because it makes the difference between an algorithm that 
actually converges and one that just runs mindlessly and picks random / wrong solutions.</p>

<p>Usually it’s not a good idea to say that the in-game score is the actual score of a solution; the approach doesn’t offer a score with a good
“granularity” so you can end up with the algorithm not making a difference between a bird that actually learned to go between pipes but hits one by mistake and another which just hit the ground (they’ll both have a 0 score).</p>

<p>It’s not wrong, indeed, but it takes waaay too much time for the algorithm to discover a better solution - we need to offer a few more <em>hints</em>.</p>

<p>So…we can also take into account:</p>

<ul>
  <li>how long the bird stayed alive (provides more accurate scores)</li>
  <li>the distance between the bird’s last position and the center of the space between the pipes (because we prefer the birds that were actually close and didn’t try to go straight through the pipe).</li>
</ul>

<p>The fitness function that I used looks like this (if the in-game score is greater than 0)</p>

<p><code class="highlighter-rouge">(game.time + game.score) / (1 + Math.Abs(game.floppy_bird.birdPosition.Y - centerPos) / 100) * 0.01f</code></p>

<p>and this one if the bird didn’t pass any group of pipes:</p>

<p><code class="highlighter-rouge">weightsList[crtIndex].fitness = (game.time + game.score);</code></p>

<h2 id="mutation--crossover-rates--population-size">Mutation &amp; Crossover Rates / Population Size</h2>

<p>Another important part too; <strong>crossover</strong> tries to “center” the population around the best solution so far (in an attempt to rise the average score of the generation) while <strong>mutation</strong> brings diversity by altering
various <em>genes</em> (in our case weights), enabling the algorithm to discover better (or worse) solutions.</p>

<p>Anyway, the whole point is to keep these in a balance; values that are too high or too low will not lead to convergence. Also a population size that is too large will just slow down the whole process but going with a small number
of candidates could limit your search domain - so there’s a chance of getting stuck in an unsatisfying local optimum.</p>

<p>In my code I used a <strong>CROSSOVER_RATE</strong> of <strong>0.8</strong> and a <strong>MUTATION_RATE</strong> of <strong>0.05</strong>, with <strong>POPULATION_SIZE</strong> = <strong>25</strong>.</p>

<p>I know this might look boring (it’s already written in the code snippet, right?) but I felt that it should be mentioned here just in case someone enounters this exact problem. This and a wrong fitness function are usually
the main reasons the algorithm might not work as expected.</p>

<h2 id="additional-notes">Additional notes</h2>

<p>It is fair to also mention this; there might be cases when a good solution fails (the bird hits one of the first pipes) and is thrown away (lost) - and the algorithm kind of falls back.
I guess it’s probably caused by a particular set of distances that won’t make the neural network trigger the jump function (considering that the pipes are random, there might be a chance).</p>

<p>Might be a good idea to make some kind of average between the previous scores and the current score. Never tried it though…</p>

<p>Aand…this project also uses some fancy <strong>mutex synchronization</strong> between processes - so multiple instances of the same game can share the best solution between them using a <strong>memory mapped file</strong> (<em>lazy parallelization</em> as I like to call it).
Wrote an article about using memory mapped files, you can find it here: <a href="http://www.codingvision.net/tips-and-tricks/c-send-data-between-processes-w-memory-mapped-file">/tips-and-tricks/c-send-data-between-processes-w-memory-mapped-file</a>.</p>

<h2 id="todos">TODOs</h2>

<p>Finally some small improvements that could prove useful; they’re not included in the code but implementing them might boost the performance:</p>

<ul>
  <li>picking weights for <strong>crossover</strong> using a weighted random function (<strong>roulette wheel selection</strong>); this way better solutions have a higher chance
to create new candidates for the next generation</li>
  <li><strong>weighted crossovers</strong> - this implies that instead of a simple arithmetic mean between the weights you should assign more “importance” to the solution
which has a higher score (<strong>weighted arithmetic mean</strong>).</li>
  <li>adding a few random weights in each new generation (boosting diversity).</li>
</ul>

<h2 id="sourcecode">Sourcecode</h2>

<p>Ok, enough of me talking; I know this is the part that gets the most attention - that’s why I’m always writing it at the end :P</p>

<p><em>// I’m publishing only the part that is relevant - because I consider that having a wall of code attached in an article looks rather bad from the reader’s point of view.</em></p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
</pre></td><td class="code"><pre><span class="k">using</span> <span class="nn">Floppy_Bird</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ANN_FlappyBird</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ANN</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">Serializable</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">class</span> <span class="nc">WeightsInfo</span>
        <span class="p">{</span>
            <span class="c1">// hidden layer weights
</span>
            <span class="k">public</span> <span class="kt">double</span><span class="p">[,]</span> <span class="n">weights1</span><span class="p">;</span>
            
            <span class="c1">// output layer weights
</span>
            <span class="k">public</span> <span class="kt">double</span><span class="p">[,]</span> <span class="n">weights2</span><span class="p">;</span>
            
            <span class="c1">// score
</span>
            <span class="k">public</span> <span class="kt">float</span> <span class="n">fitness</span><span class="p">;</span>

            <span class="k">public</span> <span class="nf">WeightsInfo</span><span class="p">(</span><span class="kt">double</span><span class="p">[,]</span> <span class="n">weights1</span><span class="p">,</span> <span class="kt">double</span><span class="p">[,]</span> <span class="n">weights2</span><span class="p">,</span> <span class="kt">float</span> <span class="n">fitness</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">weights1</span> <span class="p">=</span> <span class="n">weights1</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="n">weights2</span> <span class="p">=</span> <span class="n">weights2</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="n">fitness</span> <span class="p">=</span> <span class="n">fitness</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="nf">WeightsInfo</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">fitness</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                <span class="k">this</span><span class="p">.</span><span class="n">weights1</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">inputSize</span><span class="p">,</span> <span class="n">hiddenSize</span><span class="p">];</span>
                <span class="k">this</span><span class="p">.</span><span class="n">weights2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">hiddenSize</span><span class="p">,</span> <span class="n">outputSize</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">Game1</span> <span class="n">game</span><span class="p">;</span>
        <span class="n">Random</span> <span class="n">r</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="p">();</span>

        <span class="k">static</span> <span class="kt">int</span> <span class="n">inputSize</span><span class="p">,</span> <span class="n">hiddenSize</span><span class="p">,</span> <span class="n">outputSize</span><span class="p">;</span>
        <span class="kt">double</span><span class="p">[,]</span> <span class="n">input</span><span class="p">,</span> <span class="n">output</span><span class="p">;</span>

        <span class="n">List</span><span class="p">&lt;</span><span class="n">WeightsInfo</span><span class="p">&gt;</span> <span class="n">weightsList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">WeightsInfo</span><span class="p">&gt;();</span>
        <span class="n">List</span><span class="p">&lt;</span><span class="n">WeightsInfo</span><span class="p">&gt;</span> <span class="n">nextWeightsList</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">WeightsInfo</span><span class="p">&gt;();</span>

        <span class="kt">int</span> <span class="n">crtIndex</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="c1">// this is for sharing data between processes
</span>
        <span class="n">DataSharer</span> <span class="n">dataSharer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataSharer</span><span class="p">();</span>
        <span class="n">Mutex</span> <span class="n">mmfMutex</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>


        <span class="k">public</span> <span class="nf">ANN</span><span class="p">(</span><span class="n">Game1</span> <span class="n">game</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">game</span> <span class="p">=</span> <span class="n">game</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// spawns the first generation of birds (w/ random weights)
</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">createFirstGeneration</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">inputSize</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>
            <span class="n">hiddenSize</span> <span class="p">=</span> <span class="m">2</span><span class="p">;</span>
            <span class="n">outputSize</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>


            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">k</span> <span class="p">&lt;</span> <span class="n">POPULATION_SIZE</span><span class="p">;</span> <span class="n">k</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="kt">double</span><span class="p">[,]</span> <span class="n">_weights1</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">inputSize</span><span class="p">,</span> <span class="n">hiddenSize</span><span class="p">];</span>

                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_weights1</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">0</span><span class="p">);</span> <span class="n">i</span><span class="p">++)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">_weights1</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="n">j</span><span class="p">++)</span>
                        <span class="n">_weights1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">NextDouble</span><span class="p">()</span> <span class="p">*</span> <span class="m">2</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>


                <span class="kt">double</span><span class="p">[,]</span> <span class="n">_weights2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">hiddenSize</span><span class="p">,</span> <span class="n">outputSize</span><span class="p">];</span>

                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">_weights2</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">0</span><span class="p">);</span> <span class="n">i</span><span class="p">++)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">_weights2</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="n">j</span><span class="p">++)</span>
                        <span class="n">_weights2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">NextDouble</span><span class="p">()</span> <span class="p">*</span> <span class="m">2</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>

                <span class="n">weightsList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">WeightsInfo</span><span class="p">(</span><span class="n">_weights1</span><span class="p">,</span> <span class="n">_weights2</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span>
            <span class="p">}</span>

        <span class="p">}</span>

        <span class="kt">float</span> <span class="n">min</span> <span class="p">=</span> <span class="kt">float</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">minTowerY</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">maxTowerY</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">distanceToTower</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">minDistanceToTower</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="kt">float</span> <span class="n">centerPos</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="c1">// called by the game's update() method
</span>
        <span class="c1">// returns: true if the bird should jump, false otherwise
</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="nf">runForward</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">min</span> <span class="p">=</span> <span class="kt">float</span><span class="p">.</span><span class="n">MaxValue</span><span class="p">;</span>

            <span class="c1">// indentifies the closest tower
</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">game</span><span class="p">.</span><span class="n">tower1</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">distanceToTower</span> <span class="p">=</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">tower1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">towerPosition</span><span class="p">.</span><span class="n">X</span> <span class="p">-</span> <span class="n">game</span><span class="p">.</span><span class="n">floppy_bird</span><span class="p">.</span><span class="n">birdPosition</span><span class="p">.</span><span class="n">X</span> <span class="p">-</span> <span class="n">game</span><span class="p">.</span><span class="n">floppy_bird</span><span class="p">.</span><span class="n">birdRectangle</span><span class="p">.</span><span class="n">Width</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">distanceToTower</span> <span class="p">&lt;</span> <span class="n">min</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">min</span> <span class="p">=</span> <span class="n">distanceToTower</span><span class="p">;</span>
                    <span class="n">minDistanceToTower</span> <span class="p">=</span> <span class="n">distanceToTower</span><span class="p">;</span>
                    <span class="n">maxTowerY</span> <span class="p">=</span> <span class="n">game</span><span class="p">.</span><span class="n">tower2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">towerPosition</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span> 
                    <span class="n">minTowerY</span> <span class="p">=</span> <span class="n">maxTowerY</span> <span class="p">-</span> <span class="n">game</span><span class="p">.</span><span class="n">difference</span><span class="p">;</span> 

                    <span class="n">centerPos</span> <span class="p">=</span> <span class="p">(</span><span class="n">maxTowerY</span> <span class="p">+</span> <span class="n">minTowerY</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// the inputs for the neural network
</span>
            <span class="n">input</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="n">inputSize</span><span class="p">];</span>

            <span class="n">input</span><span class="p">[</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span> <span class="p">-</span> <span class="n">minDistanceToTower</span> <span class="p">/</span> <span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">graphics</span><span class="p">.</span><span class="n">PreferredBackBufferWidth</span> <span class="p">-</span> <span class="n">game</span><span class="p">.</span><span class="n">floppy_bird</span><span class="p">.</span><span class="n">birdPosition</span><span class="p">.</span><span class="n">X</span> <span class="p">-</span> <span class="n">game</span><span class="p">.</span><span class="n">floppy_bird</span><span class="p">.</span><span class="n">birdRectangle</span><span class="p">.</span><span class="n">Width</span><span class="p">);</span>
            <span class="n">input</span><span class="p">[</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">floppy_bird</span><span class="p">.</span><span class="n">birdPosition</span><span class="p">.</span><span class="n">Y</span> <span class="p">+</span> <span class="n">game</span><span class="p">.</span><span class="n">floppy_bird</span><span class="p">.</span><span class="n">birdRectangle</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="n">maxTowerY</span><span class="p">)</span> <span class="p">/</span> <span class="n">game</span><span class="p">.</span><span class="n">graphics</span><span class="p">.</span><span class="n">PreferredBackBufferHeight</span><span class="p">;</span>
            <span class="n">input</span><span class="p">[</span><span class="m">0</span><span class="p">,</span> <span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">floppy_bird</span><span class="p">.</span><span class="n">birdPosition</span><span class="p">.</span><span class="n">Y</span> <span class="p">-</span> <span class="n">minTowerY</span><span class="p">)</span> <span class="p">/</span> <span class="n">game</span><span class="p">.</span><span class="n">graphics</span><span class="p">.</span><span class="n">PreferredBackBufferHeight</span><span class="p">;</span>

            <span class="c1">// computing the inputs &amp; outputs for the hidden layer
</span>
            <span class="kt">double</span><span class="p">[,]</span> <span class="n">hiddenInputs</span> <span class="p">=</span> <span class="nf">multiplyArrays</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">weightsList</span><span class="p">[</span><span class="n">crtIndex</span><span class="p">].</span><span class="n">weights1</span><span class="p">);</span>
            <span class="kt">double</span><span class="p">[,]</span> <span class="n">hiddenOutputs</span> <span class="p">=</span> <span class="nf">applySigmoid</span><span class="p">(</span><span class="n">hiddenInputs</span><span class="p">);</span>

            <span class="c1">// then the final output
</span>
            <span class="n">output</span> <span class="p">=</span> <span class="nf">applySigmoid</span><span class="p">(</span><span class="nf">multiplyArrays</span><span class="p">(</span><span class="n">hiddenOutputs</span><span class="p">,</span> <span class="n">weightsList</span><span class="p">[</span><span class="n">crtIndex</span><span class="p">].</span><span class="n">weights2</span><span class="p">));</span>

           
            

            <span class="k">return</span> <span class="n">output</span><span class="p">[</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">]</span> <span class="p">&gt;</span> <span class="m">0.5</span><span class="p">;</span>


        <span class="p">}</span>


        <span class="c1">// the whole encode / decode process (just for learning purposes)
</span>
        <span class="k">void</span> <span class="nf">encode</span><span class="p">(</span><span class="n">WeightsInfo</span> <span class="n">weightsInfo</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">gene</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights1</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">0</span><span class="p">);</span> <span class="n">i</span><span class="p">++)</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights1</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="n">j</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">gene</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]);</span>
                <span class="p">}</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights2</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">0</span><span class="p">);</span> <span class="n">i</span><span class="p">++)</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights2</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="n">j</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">gene</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]);</span>
                <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">void</span> <span class="nf">decode</span><span class="p">(</span><span class="n">WeightsInfo</span> <span class="n">weightsInfo</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">gene</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights1</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">0</span><span class="p">);</span> <span class="n">i</span><span class="p">++)</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights1</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="n">j</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="n">gene</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
                    <span class="n">gene</span><span class="p">.</span><span class="nf">RemoveAt</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
                <span class="p">}</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights2</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">0</span><span class="p">);</span> <span class="n">i</span><span class="p">++)</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights2</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="n">j</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">weightsInfo</span><span class="p">.</span><span class="n">weights2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="n">gene</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
                    <span class="n">gene</span><span class="p">.</span><span class="nf">RemoveAt</span><span class="p">(</span><span class="m">0</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// creates a new candidate solution using crossover
</span>
        <span class="k">void</span> <span class="nf">crossover</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">gene1</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">gene2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">NextDouble</span><span class="p">()</span> <span class="p">&gt;</span> <span class="n">CROSSOVER_RATE</span><span class="p">)</span>
                <span class="k">return</span><span class="p">;</span>


            <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">descendant1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;();</span>
            <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">descendant2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;();</span>

            <span class="c1">// mixing the genes using the arithmetic mean
</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">gene1</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="n">descendant1</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="n">gene1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">+</span> <span class="n">gene2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">/</span> <span class="m">2.0</span><span class="p">);</span>
                <span class="n">descendant2</span><span class="p">.</span><span class="nf">Add</span><span class="p">((</span><span class="n">gene1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">+</span> <span class="n">gene2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">/</span> <span class="m">2.0</span><span class="p">);</span>
            <span class="p">}</span>
            

            <span class="c1">// decoding the result back to the "weights-format"
</span>
            <span class="n">WeightsInfo</span> <span class="n">weightsInfo1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WeightsInfo</span><span class="p">();</span>
            <span class="nf">decode</span><span class="p">(</span><span class="n">weightsInfo1</span><span class="p">,</span> <span class="n">descendant1</span><span class="p">);</span>
            <span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">weightsInfo1</span><span class="p">);</span>


            <span class="n">WeightsInfo</span> <span class="n">weightsInfo2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WeightsInfo</span><span class="p">();</span>
            <span class="nf">decode</span><span class="p">(</span><span class="n">weightsInfo2</span><span class="p">,</span> <span class="n">descendant2</span><span class="p">);</span>
            <span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">weightsInfo2</span><span class="p">);</span>

        <span class="p">}</span>

        <span class="c1">// randomly adjusts a weight in order to improve it
</span>
        <span class="kt">bool</span> <span class="nf">mutate</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">gene</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">bool</span> <span class="n">mutated</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">gene</span><span class="p">.</span><span class="n">Count</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">NextDouble</span><span class="p">()</span> <span class="p">&lt;</span> <span class="n">MUTATION_RATE</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">gene</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">+=</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">NextDouble</span><span class="p">()</span> <span class="p">*</span> <span class="m">2</span> <span class="p">-</span> <span class="m">1</span><span class="p">);</span>
                    <span class="n">mutated</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">mutated</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// selection function for crossover (picks the better one from 2 random candidates)
</span>
        <span class="n">WeightsInfo</span> <span class="k">select</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">i1</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">i2</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="k">while</span> <span class="p">(</span><span class="n">i1</span> <span class="p">==</span> <span class="n">i2</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">i1</span> <span class="p">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">weightsList</span><span class="p">.</span><span class="n">Count</span> <span class="p">/</span> <span class="m">3</span><span class="p">);</span>
                <span class="n">i2</span> <span class="p">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">weightsList</span><span class="p">.</span><span class="n">Count</span> <span class="p">/</span> <span class="m">3</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">weightsList</span><span class="p">[</span><span class="n">i1</span><span class="p">].</span><span class="n">fitness</span> <span class="p">&gt;</span> <span class="n">weightsList</span><span class="p">[</span><span class="n">i2</span><span class="p">].</span><span class="n">fitness</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">weightsList</span><span class="p">[</span><span class="n">i1</span><span class="p">];</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="n">weightsList</span><span class="p">[</span><span class="n">i2</span><span class="p">];</span>
        <span class="p">}</span>


        <span class="kt">double</span> <span class="n">CROSSOVER_RATE</span> <span class="p">=</span> <span class="m">0.8</span><span class="p">;</span>
        <span class="kt">double</span> <span class="n">MUTATION_RATE</span> <span class="p">=</span> <span class="m">0.05</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">POPULATION_SIZE</span> <span class="p">=</span> <span class="m">25</span><span class="p">;</span>

        <span class="kt">float</span> <span class="n">averageFitness</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">maxFitness</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">generation</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">breedNetworks</span><span class="p">()</span>
        <span class="p">{</span>

            <span class="c1">// updates the score
</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">score</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
                <span class="n">weightsList</span><span class="p">[</span><span class="n">crtIndex</span><span class="p">].</span><span class="n">fitness</span> <span class="p">=</span> <span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">time</span> <span class="p">+</span> <span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">)</span> <span class="p">/</span> <span class="p">(</span><span class="m">1</span> <span class="p">+</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">floppy_bird</span><span class="p">.</span><span class="n">birdPosition</span><span class="p">.</span><span class="n">Y</span> <span class="p">-</span> <span class="n">centerPos</span><span class="p">)</span> <span class="p">/</span> <span class="m">100</span><span class="p">)</span> <span class="p">*</span> <span class="m">0.01f</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">weightsList</span><span class="p">[</span><span class="n">crtIndex</span><span class="p">].</span><span class="n">fitness</span> <span class="p">=</span> <span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">time</span> <span class="p">+</span> <span class="n">game</span><span class="p">.</span><span class="n">score</span><span class="p">);</span>

            <span class="n">averageFitness</span> <span class="p">+=</span> <span class="n">weightsList</span><span class="p">[</span><span class="n">crtIndex</span><span class="p">].</span><span class="n">fitness</span><span class="p">;</span>
            <span class="n">maxFitness</span> <span class="p">=</span> <span class="n">maxFitness</span> <span class="p">&gt;</span> <span class="n">weightsList</span><span class="p">[</span><span class="n">crtIndex</span><span class="p">].</span><span class="n">fitness</span> <span class="p">?</span> <span class="n">maxFitness</span> <span class="p">:</span> <span class="n">weightsList</span><span class="p">[</span><span class="n">crtIndex</span><span class="p">].</span><span class="n">fitness</span><span class="p">;</span>


            <span class="k">if</span> <span class="p">(</span><span class="n">crtIndex</span> <span class="p">+</span> <span class="m">1</span> <span class="p">&lt;</span> <span class="n">weightsList</span><span class="p">.</span><span class="n">Count</span><span class="p">)</span>
                <span class="n">crtIndex</span><span class="p">++;</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">crtIndex</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                <span class="n">generation</span><span class="p">++;</span>

                <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"GEN: "</span> <span class="p">+</span> <span class="n">generation</span> <span class="p">+</span> <span class="s">" | AVG: "</span> <span class="p">+</span> <span class="n">averageFitness</span> <span class="p">/</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">POPULATION_SIZE</span> <span class="p">+</span> <span class="s">" | MAX: "</span> <span class="p">+</span> <span class="n">maxFitness</span><span class="p">);</span>
                <span class="n">averageFitness</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                <span class="n">maxFitness</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>


                <span class="n">weightsList</span> <span class="p">=</span> <span class="n">weightsList</span><span class="p">.</span><span class="nf">OrderByDescending</span><span class="p">(</span><span class="n">wi</span> <span class="p">=&gt;</span> <span class="n">wi</span><span class="p">.</span><span class="n">fitness</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>

                <span class="c1">// starting with a large mutation rate so there's will be more solutions to choose from
</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">weightsList</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">fitness</span> <span class="p">&lt;</span> <span class="m">2</span><span class="p">)</span>
                    <span class="n">MUTATION_RATE</span> <span class="p">=</span> <span class="m">0.9</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">MUTATION_RATE</span> <span class="p">=</span> <span class="m">0.05</span><span class="p">;</span>

                <span class="c1">// adding better solutions from the other instances (if any)
</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nextWeightsList</span><span class="p">.</span><span class="n">Count</span> <span class="p">+</span> <span class="m">3</span> <span class="p">&lt;=</span> <span class="n">POPULATION_SIZE</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">// the whole synchronization thingy
</span>
                    <span class="k">try</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">mmfMutex</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                            <span class="n">mmfMutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">.</span><span class="nf">OpenExisting</span><span class="p">(</span><span class="s">"Global\\mmfMutex"</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">mmfMutex</span><span class="p">.</span><span class="nf">WaitOne</span><span class="p">())</span>
                        <span class="p">{</span>

                            <span class="n">WeightsInfo</span> <span class="n">wi</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WeightsInfo</span><span class="p">();</span>
                            <span class="n">wi</span> <span class="p">=</span> <span class="n">dataSharer</span><span class="p">.</span><span class="nf">getFromMemoryMap</span><span class="p">();</span>
                            
                            <span class="k">if</span> <span class="p">(</span><span class="n">wi</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">wi</span><span class="p">.</span><span class="n">fitness</span> <span class="p">&lt;</span> <span class="n">weightsList</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">fitness</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">wi</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                                    <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Updated - NULL -&gt; "</span> <span class="p">+</span> <span class="n">weightsList</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">fitness</span><span class="p">);</span>

                                <span class="k">if</span> <span class="p">(</span><span class="n">wi</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                                    <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Updated - "</span> <span class="p">+</span> <span class="n">wi</span><span class="p">.</span><span class="n">fitness</span> <span class="p">+</span> <span class="s">" -&gt; "</span> <span class="p">+</span> <span class="n">weightsList</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">fitness</span><span class="p">);</span>

                                <span class="n">dataSharer</span><span class="p">.</span><span class="nf">writeToMemoryMap</span><span class="p">(</span><span class="n">weightsList</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
                            <span class="p">}</span>

                            <span class="k">if</span> <span class="p">(</span><span class="n">wi</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">wi</span><span class="p">.</span><span class="n">fitness</span> <span class="p">&gt;</span> <span class="n">weightsList</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">fitness</span><span class="p">)</span>
                            <span class="p">{</span>
                                <span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">wi</span><span class="p">);</span>
                            <span class="p">}</span>

                            <span class="n">mmfMutex</span><span class="p">.</span><span class="nf">ReleaseMutex</span><span class="p">();</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">catch</span> <span class="p">(</span><span class="n">WaitHandleCannotBeOpenedException</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">mmfMutex</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Mutex</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="s">"Global\\mmfMutex"</span><span class="p">);</span>
                        <span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">weightsList</span><span class="p">.</span><span class="nf">Take</span><span class="p">(</span><span class="m">3</span><span class="p">));</span>

                        <span class="n">mmfMutex</span><span class="p">.</span><span class="nf">ReleaseMutex</span><span class="p">();</span>
                    <span class="p">}</span>

                    <span class="c1">// adding elites to the next generation
</span>
                    <span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">weightsList</span><span class="p">.</span><span class="nf">Take</span><span class="p">(</span><span class="m">3</span><span class="p">));</span>
                <span class="p">}</span>

                <span class="c1">// creating a new generation 
</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">nextWeightsList</span><span class="p">.</span><span class="n">Count</span> <span class="p">&lt;</span> <span class="n">POPULATION_SIZE</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">WeightsInfo</span> <span class="n">w1</span> <span class="p">=</span> <span class="k">select</span><span class="p">();</span>
                    <span class="n">WeightsInfo</span> <span class="n">w2</span> <span class="p">=</span> <span class="k">select</span><span class="p">();</span>


                    <span class="k">while</span> <span class="p">(</span><span class="n">w1</span> <span class="p">==</span> <span class="n">w2</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">w1</span> <span class="p">=</span> <span class="k">select</span><span class="p">();</span>
                        <span class="n">w2</span> <span class="p">=</span> <span class="k">select</span><span class="p">();</span>
                    <span class="p">}</span>

                    <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">gene1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;();</span>
                    <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">gene2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;();</span>

                    <span class="nf">encode</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">gene1</span><span class="p">);</span>
                    <span class="nf">encode</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">gene2</span><span class="p">);</span>


                    <span class="nf">crossover</span><span class="p">(</span><span class="n">gene1</span><span class="p">,</span> <span class="n">gene2</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nf">mutate</span><span class="p">(</span><span class="n">gene1</span><span class="p">))</span>
                        <span class="n">w1</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WeightsInfo</span><span class="p">();</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nf">mutate</span><span class="p">(</span><span class="n">gene2</span><span class="p">))</span>
                        <span class="n">w2</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WeightsInfo</span><span class="p">();</span>

                    <span class="nf">decode</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">gene1</span><span class="p">);</span> 
                    <span class="nf">decode</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span> <span class="n">gene2</span><span class="p">);</span> 

                    <span class="k">if</span> <span class="p">(!</span><span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">w1</span><span class="p">))</span>
                        <span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">w1</span><span class="p">);</span>
                    
                    <span class="k">if</span> <span class="p">(!</span><span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">w2</span><span class="p">))</span>
                        <span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">w2</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="n">weightsList</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
                <span class="n">nextWeightsList</span> <span class="p">=</span> <span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">OrderByDescending</span><span class="p">(</span><span class="n">wi</span> <span class="p">=&gt;</span> <span class="n">wi</span><span class="p">.</span><span class="n">fitness</span><span class="p">).</span><span class="nf">ToList</span><span class="p">();</span>


                <span class="n">weightsList</span><span class="p">.</span><span class="nf">AddRange</span><span class="p">(</span><span class="n">nextWeightsList</span><span class="p">);</span>

                <span class="n">nextWeightsList</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// -- below are some methods used to compute the outputs of the neural networks
</span>

        <span class="err">#</span><span class="n">region</span> <span class="n">MathHelpers</span>

        <span class="kt">double</span><span class="p">[,]</span> <span class="nf">applySigmoid</span><span class="p">(</span><span class="kt">double</span><span class="p">[,]</span> <span class="n">array</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">array</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">0</span><span class="p">);</span> <span class="n">i</span><span class="p">++)</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">array</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="n">j</span><span class="p">++)</span>
                    <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]);</span>

            <span class="k">return</span> <span class="n">array</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">double</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="kt">double</span> <span class="n">x</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="m">1.0</span> <span class="p">/</span> <span class="p">(</span><span class="m">1.0</span> <span class="p">+</span> <span class="n">Math</span><span class="p">.</span><span class="nf">Exp</span><span class="p">(-</span><span class="n">x</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="kt">double</span><span class="p">[,]</span> <span class="nf">multiplyArrays</span><span class="p">(</span><span class="kt">double</span><span class="p">[,]</span> <span class="n">a1</span><span class="p">,</span> <span class="kt">double</span><span class="p">[,]</span> <span class="n">a2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">double</span><span class="p">[,]</span> <span class="n">a3</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">a1</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="n">a2</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">)];</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">a3</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">0</span><span class="p">);</span> <span class="n">i</span><span class="p">++)</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">a3</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="n">j</span><span class="p">++)</span>
                <span class="p">{</span>
                    <span class="n">a3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">k</span> <span class="p">&lt;</span> <span class="n">a1</span><span class="p">.</span><span class="nf">GetLength</span><span class="p">(</span><span class="m">1</span><span class="p">);</span> <span class="n">k</span><span class="p">++)</span>
                        <span class="n">a3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="p">=</span> <span class="n">a3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="p">+</span> <span class="n">a1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="p">*</span> <span class="n">a2</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">j</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="n">a3</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="err">#</span><span class="n">endregion</span> <span class="n">MathHelpers</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="auxiliary-files">Auxiliary files</h2>

<p>The <strong>DataSharer</strong> class:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO.MemoryMappedFiles</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Serialization.Formatters.Binary</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ANN_FlappyBird</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">DataSharer</span>
    <span class="p">{</span>
        <span class="n">MemoryMappedFile</span> <span class="n">mmf</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">writeToMemoryMap</span><span class="p">(</span><span class="n">ANN_FlappyBird</span><span class="p">.</span><span class="n">ANN</span><span class="p">.</span><span class="n">WeightsInfo</span> <span class="n">weightsInfo</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">MMF_MAX_SIZE</span> <span class="p">=</span> <span class="m">1024</span><span class="p">;</span>  
            <span class="k">const</span> <span class="kt">int</span> <span class="n">MMF_VIEW_SIZE</span> <span class="p">=</span> <span class="m">1024</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">mmf</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="n">mmf</span> <span class="p">=</span> <span class="n">MemoryMappedFile</span><span class="p">.</span><span class="nf">CreateOrOpen</span><span class="p">(</span><span class="s">"mmf1"</span><span class="p">,</span> <span class="n">MMF_MAX_SIZE</span><span class="p">,</span> <span class="n">MemoryMappedFileAccess</span><span class="p">.</span><span class="n">ReadWrite</span><span class="p">);</span>

            <span class="n">MemoryMappedViewStream</span> <span class="n">mmvStream</span> <span class="p">=</span> <span class="n">mmf</span><span class="p">.</span><span class="nf">CreateViewStream</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">MMF_VIEW_SIZE</span><span class="p">);</span>

            <span class="n">BinaryFormatter</span> <span class="n">formatter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryFormatter</span><span class="p">();</span>
            <span class="n">formatter</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">mmvStream</span><span class="p">,</span> <span class="n">weightsInfo</span><span class="p">);</span>
            <span class="n">mmvStream</span><span class="p">.</span><span class="nf">Seek</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">SeekOrigin</span><span class="p">.</span><span class="n">Begin</span><span class="p">);</span>


        <span class="p">}</span>


        <span class="k">public</span> <span class="n">ANN</span><span class="p">.</span><span class="n">WeightsInfo</span> <span class="nf">getFromMemoryMap</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="kt">int</span> <span class="n">MMF_VIEW_SIZE</span> <span class="p">=</span> <span class="m">1024</span><span class="p">;</span>

            <span class="n">ANN</span><span class="p">.</span><span class="n">WeightsInfo</span> <span class="n">weightsInfo</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">mmf</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="n">mmf</span> <span class="p">=</span> <span class="n">MemoryMappedFile</span><span class="p">.</span><span class="nf">OpenExisting</span><span class="p">(</span><span class="s">"mmf1"</span><span class="p">);</span>
                    <span class="n">weightsInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ANN</span><span class="p">.</span><span class="nf">WeightsInfo</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">StackTrace</span><span class="p">);</span>
                    <span class="n">weightsInfo</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
                    <span class="k">return</span> <span class="n">weightsInfo</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
           
            <span class="n">MemoryMappedViewStream</span> <span class="n">mmvStream</span> <span class="p">=</span> <span class="n">mmf</span><span class="p">.</span><span class="nf">CreateViewStream</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">MMF_VIEW_SIZE</span><span class="p">);</span>

            <span class="n">BinaryFormatter</span> <span class="n">formatter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BinaryFormatter</span><span class="p">();</span>

            <span class="c1">// needed for deserialization
</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">MMF_VIEW_SIZE</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">mmvStream</span><span class="p">.</span><span class="n">CanRead</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">mmvStream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">MMF_VIEW_SIZE</span><span class="p">);</span>

                <span class="n">weightsInfo</span> <span class="p">=</span> <span class="p">(</span><span class="n">ANN_FlappyBird</span><span class="p">.</span><span class="n">ANN</span><span class="p">.</span><span class="n">WeightsInfo</span><span class="p">)</span><span class="n">formatter</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">else</span>
                <span class="n">weightsInfo</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">weightsInfo</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

:ET