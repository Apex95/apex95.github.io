I"h <p><em>Hello world!</em></p>

<p>Today we continue the <em>‚ÄúTrolling the Decompiler‚Äù</em> series (first part here: <a href="http://www.codingvision.net/security/c-prevent-reflector-from-decompiling">Prevent Reflector from Decompiling</a>)
but now with a more serious approach - this one should work on <strong>any decompiler</strong>.</p>

<p><u>The point is:</u> it is rather difficult to make <strong>.NET</strong> programs run with a key or license; since these can be reverted back
to their sourcecode, anyone can alter it or just learn to create fake keys that will be seen as valid.</p>

<figure class="image">
  <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-echo="/imgs/posts/c-prevent-decompilation-by-decrypting-source-at-runtime/1.png" alt="Data placed as plain text in a .NET application can be easily discovered" />
  <figcaption><p>Data placed as plain text in a .NET application can be easily discovered</p>
</figcaption>
</figure>

<h2 id="possible-solution">Possible Solution</h2>

<p>One way to make an application a little bit more difficult to crack would be to deliver it as a program
that <strong>decrypts</strong> instructions, <strong>compiles</strong> and <strong>runs</strong> them only when needed. This way, if someone finds out where
the sourcecode is stored, it will still be encrypted and without a <strong>key</strong> (or license) it is unusable.</p>

<p>We‚Äôre kinda writing polymorphic stuff here - AVs won‚Äôt be happy; actually‚Ä¶only 2/57 don‚Äôt like it, we‚Äôre good.</p>

<h2 id="1-making-the-compiler">1. Making the Compiler</h2>

<p>We‚Äôre not really going to reinvent the wheel here - .NET seems to allow us to use the original compiler to produce
an <code class="highlighter-rouge">Assembly</code>. Just as always, we start with a <code class="highlighter-rouge">CodeDomProvider</code>, add a bunch of settings using <code class="highlighter-rouge">CompilerParameters</code> and
a few sourcecodes.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="n">CodeDomProvider</span> <span class="n">provider</span> <span class="p">=</span> <span class="n">CodeDomProvider</span><span class="p">.</span><span class="nf">CreateProvider</span><span class="p">(</span><span class="s">"CSharp"</span><span class="p">);</span>

<span class="n">CompilerParameters</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CompilerParameters</span><span class="p">();</span>

<span class="n">parameters</span><span class="p">.</span><span class="n">GenerateExecutable</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="n">parameters</span><span class="p">.</span><span class="n">GenerateInMemory</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span> <span class="c1">// it's still going to generate a file somewhere in AppData (temp)</span>
<span class="n">parameters</span><span class="p">.</span><span class="n">TreatWarningsAsErrors</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
            
<span class="c1">// I need these references because the program that I will 'secure'</span>
<span class="c1">// is that Form from the photo above that requires a password</span>
<span class="n">parameters</span><span class="p">.</span><span class="n">ReferencedAssemblies</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"System.Windows.Forms.dll"</span><span class="p">);</span>
<span class="n">parameters</span><span class="p">.</span><span class="n">ReferencedAssemblies</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"System.dll"</span><span class="p">);</span>
<span class="n">parameters</span><span class="p">.</span><span class="n">ReferencedAssemblies</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"System.Drawing.dll"</span><span class="p">);</span>

<span class="c1">// getContents() is a method that extracts &amp; decrypts the sourcecodes </span>
<span class="c1">// of the 'secured' application and returns everything as an array of Strings</span>
<span class="c1">// in order to be compiled</span>

<span class="n">CompilerResults</span> <span class="n">result</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="nf">CompileAssemblyFromSource</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nf">getContents</span><span class="p">());</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If you look around, there‚Äôs also an article that provides a little bit more detail about how to compile code at runtime
using <code class="highlighter-rouge">CSharpCodeProvider</code> and <code class="highlighter-rouge">ICodeCompiler</code> which are now considered obsolete, but the code is similar.</p>

<h2 id="2-running-the-compiled-assembly">2. Running the Compiled Assembly</h2>

<p>What we‚Äôre interested in is <code class="highlighter-rouge">result.CompiledAssembly</code> - in order to run it we have to create an <strong>instance</strong> of the 
method that serves as <strong>entrypoint</strong> and then <strong>invoking</strong> it.</p>

<p><u>Short note:</u> if the assembly that you‚Äôre trying to run belongs to a <strong>Console Application</strong> and this program has the same
project type, you might need to call <code class="highlighter-rouge">FreeConsole()</code> and then <code class="highlighter-rouge">AllocConsole()</code>. Without recreating the <strong>Console</strong> there seems 
to be no output from the compiled assembly.</p>

<p>This is how we can run the compiled code:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">Assembly</span> <span class="n">assembly</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">CompiledAssembly</span><span class="p">;</span>

<span class="c1">//taking the entrypoint</span>
<span class="n">MethodInfo</span> <span class="n">methodInfo</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="n">EntryPoint</span><span class="p">;</span>

<span class="c1">// creating an instance</span>
<span class="kt">object</span> <span class="n">entryPointInstance</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="nf">CreateInstance</span><span class="p">(</span><span class="n">methodInfo</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>

<span class="c1">// then invoking it with no arguments (hence the 'null')</span>
<span class="n">methodInfo</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">entryPointInstance</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="3-encrypting--attaching-sourcecodes">3. Encrypting &amp; Attaching Sourcecodes</h2>

<p>This is one of the tough parts - we take the sourcecodes of the files that we want to secure and 
encrypt them (I use <strong>AES</strong> with <strong>Rijndael</strong>‚Äôs algorithm) then attach the results at the end of the executable that we‚Äôve
been working on at the previous steps.</p>

<p>Here, the content of the executable and each sourcecode are separated by a sequence of <strong>3</strong> <strong>FS</strong> (File Separator Character).
It‚Äôs not the clean way to handle this‚Ä¶don‚Äôt use it in serious projects; but for this tutorial it should be fine.</p>

<p><strong>FS</strong> = <strong>28</strong>(dec) = <strong>1C</strong>(hex);</p>

<figure class="image">
  <img src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-echo="/imgs/posts/c-prevent-decompilation-by-decrypting-source-at-runtime/2.png" alt="Hex editor view: the format of the encrypter with 2 attached files." />
  <figcaption><p>Hex editor view: the format of the encrypter with 2 attached files.</p>
</figcaption>
</figure>

<p>The method that I use looks like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="k">void</span> <span class="nf">appendContents</span><span class="p">(</span><span class="n">String</span> <span class="n">fileName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// fileName contains the name of the decrypter </span>
    <span class="n">FileStream</span> <span class="n">fstream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Append</span><span class="p">);</span>
    
    <span class="c1">// attaching the first 3 FS chars</span>
    <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
    <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
    <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>

    <span class="c1">// grabbing any .cs file (anything that needs to be encrypted and attached)</span>
    <span class="kt">string</span><span class="p">[]</span> <span class="n">sourceFiles</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">GetFiles</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="nf">GetDirectoryName</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetEntryAssembly</span><span class="p">().</span><span class="n">Location</span><span class="p">),</span> <span class="s">"*.cs"</span><span class="p">,</span> <span class="n">SearchOption</span><span class="p">.</span><span class="n">AllDirectories</span><span class="p">);</span>

    <span class="c1">// taking each source file</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">sourceFiles</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllBytes</span><span class="p">(</span><span class="n">sourceFiles</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                

        <span class="c1">// removing UTF8's byte order mark, if needed</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">2</span> <span class="p">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="m">0xEF</span> <span class="p">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="m">0xBB</span> <span class="p">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">==</span> <span class="m">0XBF</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// skipping the first 3 bytes</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">newBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">buffer</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">3</span><span class="p">];</span>
            <span class="n">Array</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="n">newBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">3</span><span class="p">);</span>

            <span class="c1">// encrypting with a test key</span>
            <span class="n">newBuffer</span> <span class="p">=</span> <span class="nf">EncryptMessage</span><span class="p">(</span><span class="n">newBuffer</span><span class="p">,</span> <span class="s">"abcdabcdabcdabcdabcdabcdabcdabcd"</span><span class="p">);</span>

            <span class="c1">// writing...</span>
            <span class="n">fstream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">newBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">newBuffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="c1">// same thing as above, but for texts without BOM</span>
            <span class="n">buffer</span> <span class="p">=</span> <span class="nf">EncryptMessage</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"abcdabcdabcdabcdabcdabcdabcdabcd"</span><span class="p">);</span>
            <span class="n">fstream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// more separators!</span>
        <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
        <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
        <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I‚Äôll not add <code class="highlighter-rouge">EncryptMessage()</code>‚Äôs code here since it‚Äôs not related to the actual subject - you can find it below,
in the complete sourcecode.</p>

<h2 id="4-extracting--decrypting-sourcecodes">4. Extracting &amp; Decrypting Sourcecodes</h2>

<p>Procedure that runs before the whole compile &amp; run thingy - we look for any sequence of <strong>3</strong> <strong>FS</strong> characters,
skip the executable‚Äôs content, take the encrypted sourcecode and run it through the decryption method - the result
is pure C# code that will be given to the compiler.</p>

<p>Remember to replace the <code class="highlighter-rouge">"abcdabcdabc..."</code> decryption key with what the user inputs in order to use the program
(like a license) - <strong>line 31</strong>.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre><span class="k">static</span> <span class="n">String</span><span class="p">[]</span> <span class="nf">getContents</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// reads all the bytes found in the running executable's file</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllBytes</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetEntryAssembly</span><span class="p">().</span><span class="n">Location</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            
    <span class="n">List</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="n">sourceFiles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;();</span>

    <span class="c1">// skipping the original executable's data</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">bytes</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">2</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="c1">// if there are 3 FS characters in a row</span>
        <span class="c1">// then there's a source file</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">==</span> <span class="m">28</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">i</span> <span class="p">+=</span> <span class="m">3</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// here I should keep one sourcefile at a time</span>
    <span class="n">List</span><span class="p">&lt;</span><span class="n">Byte</span><span class="p">&gt;</span> <span class="n">sourceFileBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Byte</span><span class="p">&gt;(</span><span class="m">4000</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">bytes</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">2</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="c1">// checking if I reached the end of a sourcefile</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">==</span> <span class="m">28</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// TO DO: decrypt with the key given by the user of the program</span>
            <span class="n">sourceFiles</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nf">DecryptMessage</span><span class="p">(</span><span class="n">sourceFileBuffer</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">(),</span> <span class="s">"abcdabcdabcdabcdabcdabcdabcdabcd"</span><span class="p">)));</span>
            <span class="n">sourceFileBuffer</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
            <span class="n">i</span> <span class="p">+=</span> <span class="m">2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
            <span class="n">sourceFileBuffer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="c1">// returning the array of sourcecodes</span>
    <span class="k">return</span> <span class="n">sourceFiles</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="final-notes--complete-sourcecode">Final Notes &amp; Complete Sourcecode</h2>

<p>Below you‚Äôll find the sourcecode I ended up with while writing this article. It‚Äôs more like a fast way to explain an idea - it needs some ‚Äúpatching‚Äù.</p>

<p>In order to actually use it you should split this into <strong>2</strong> programs - one for encrypting and attaching and the other to do the decryption, compilation &amp; execution.
You send <strong>only</strong> the latter one to the user - so he won‚Äôt get the <strong>encryption key</strong> - this or switch to an <strong>asymmetric</strong> algorithm. Also don‚Äôt forget to remove 
the hardcoded <strong>decryption key</strong> and ask the user for his own.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
</pre></td><td class="rouge-code"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.CodeDom.Compiler</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">ConsoleApplication1</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">int</span> <span class="n">CHAR_FS</span> <span class="p">=</span> <span class="m">28</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">EncryptMessage</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">text</span><span class="p">,</span> <span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">RijndaelManaged</span> <span class="n">aes</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RijndaelManaged</span><span class="p">();</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">KeySize</span> <span class="p">=</span> <span class="m">256</span><span class="p">;</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="m">256</span><span class="p">;</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">Padding</span> <span class="p">=</span> <span class="n">PaddingMode</span><span class="p">.</span><span class="n">Zeros</span><span class="p">;</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">Mode</span> <span class="p">=</span> <span class="n">CipherMode</span><span class="p">.</span><span class="n">CBC</span><span class="p">;</span>

            <span class="n">aes</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
            <span class="n">aes</span><span class="p">.</span><span class="nf">GenerateIV</span><span class="p">();</span>

            <span class="kt">string</span> <span class="n">IV</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">aes</span><span class="p">.</span><span class="n">IV</span><span class="p">);</span>

            <span class="n">ICryptoTransform</span> <span class="n">AESEncrypt</span> <span class="p">=</span> <span class="n">aes</span><span class="p">.</span><span class="nf">CreateEncryptor</span><span class="p">(</span><span class="n">aes</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">aes</span><span class="p">.</span><span class="n">IV</span><span class="p">);</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="n">text</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">AESEncrypt</span><span class="p">.</span><span class="nf">TransformFinalBlock</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span> <span class="p">+</span> <span class="n">IV</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">DecryptMessage</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">text</span><span class="p">,</span> <span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">RijndaelManaged</span> <span class="n">aes</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RijndaelManaged</span><span class="p">();</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">KeySize</span> <span class="p">=</span> <span class="m">256</span><span class="p">;</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">BlockSize</span> <span class="p">=</span> <span class="m">256</span><span class="p">;</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">Padding</span> <span class="p">=</span> <span class="n">PaddingMode</span><span class="p">.</span><span class="n">Zeros</span><span class="p">;</span>
            <span class="n">aes</span><span class="p">.</span><span class="n">Mode</span> <span class="p">=</span> <span class="n">CipherMode</span><span class="p">.</span><span class="n">CBC</span><span class="p">;</span>

            <span class="n">aes</span><span class="p">.</span><span class="n">Key</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

            <span class="kt">byte</span><span class="p">[]</span> <span class="n">IV</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">32</span><span class="p">];</span>
            <span class="n">Array</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">32</span><span class="p">,</span> <span class="n">IV</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">32</span><span class="p">);</span>

            <span class="kt">byte</span><span class="p">[]</span> <span class="n">text2</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">text</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">32</span><span class="p">];</span>
            <span class="n">Array</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">text2</span><span class="p">,</span> <span class="n">text2</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

            <span class="n">aes</span><span class="p">.</span><span class="n">IV</span> <span class="p">=</span> <span class="n">IV</span><span class="p">;</span>

            <span class="n">ICryptoTransform</span> <span class="n">AESDecrypt</span> <span class="p">=</span> <span class="n">aes</span><span class="p">.</span><span class="nf">CreateDecryptor</span><span class="p">(</span><span class="n">aes</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="n">aes</span><span class="p">.</span><span class="n">IV</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">AESDecrypt</span><span class="p">.</span><span class="nf">TransformFinalBlock</span><span class="p">(</span><span class="n">text2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">text2</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">static</span> <span class="k">void</span> <span class="nf">appendContents</span><span class="p">(</span><span class="n">String</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">FileStream</span> <span class="n">fstream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Append</span><span class="p">);</span>
            <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
            <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
            <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>


            <span class="kt">string</span><span class="p">[]</span> <span class="n">sourceFiles</span> <span class="p">=</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">GetFiles</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="nf">GetDirectoryName</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetEntryAssembly</span><span class="p">().</span><span class="n">Location</span><span class="p">),</span> <span class="s">"*.cs"</span><span class="p">,</span> <span class="n">SearchOption</span><span class="p">.</span><span class="n">AllDirectories</span><span class="p">);</span>


            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">sourceFiles</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllBytes</span><span class="p">(</span><span class="n">sourceFiles</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                

                <span class="c1">// removing UTF8's byte order mark...</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">2</span> <span class="p">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">==</span> <span class="m">0xEF</span> <span class="p">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="m">0xBB</span> <span class="p">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">==</span> <span class="m">0XBF</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">byte</span><span class="p">[]</span> <span class="n">newBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">buffer</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">3</span><span class="p">];</span>
                    <span class="n">Array</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="n">newBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">3</span><span class="p">);</span>

                    <span class="n">newBuffer</span> <span class="p">=</span> <span class="nf">EncryptMessage</span><span class="p">(</span><span class="n">newBuffer</span><span class="p">,</span> <span class="s">"abcdabcdabcdabcdabcdabcdabcdabcd"</span><span class="p">);</span>

                    <span class="n">fstream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">newBuffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">newBuffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">buffer</span> <span class="p">=</span> <span class="nf">EncryptMessage</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"abcdabcdabcdabcdabcdabcdabcdabcd"</span><span class="p">);</span>

                    <span class="n">fstream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
                <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
                <span class="n">fstream</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="n">CHAR_FS</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">static</span> <span class="n">String</span><span class="p">[]</span> <span class="nf">getContents</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">bytes</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllBytes</span><span class="p">(</span><span class="n">Assembly</span><span class="p">.</span><span class="nf">GetEntryAssembly</span><span class="p">().</span><span class="n">Location</span><span class="p">);</span>

            <span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
            
            <span class="n">List</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="n">sourceFiles</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;();</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">bytes</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">2</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">==</span> <span class="m">28</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">i</span> <span class="p">+=</span> <span class="m">3</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">List</span><span class="p">&lt;</span><span class="n">Byte</span><span class="p">&gt;</span> <span class="n">sourceFileBuffer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Byte</span><span class="p">&gt;(</span><span class="m">4000</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">bytes</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">2</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">==</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">1</span><span class="p">]</span> <span class="p">==</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">&amp;&amp;</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span> <span class="p">+</span> <span class="m">2</span><span class="p">]</span> <span class="p">==</span> <span class="m">28</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">sourceFiles</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nf">DecryptMessage</span><span class="p">(</span><span class="n">sourceFileBuffer</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">(),</span> <span class="s">"abcdabcdabcdabcdabcdabcdabcdabcd"</span><span class="p">)));</span>
                    <span class="n">sourceFileBuffer</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
                    <span class="n">i</span> <span class="p">+=</span> <span class="m">2</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                    <span class="n">sourceFileBuffer</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

            <span class="p">}</span>
            <span class="k">return</span> <span class="n">sourceFiles</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">CodeDomProvider</span> <span class="n">provider</span> <span class="p">=</span> <span class="n">CodeDomProvider</span><span class="p">.</span><span class="nf">CreateProvider</span><span class="p">(</span><span class="s">"CSharp"</span><span class="p">);</span>

            <span class="n">CompilerParameters</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CompilerParameters</span><span class="p">();</span>

            <span class="n">parameters</span><span class="p">.</span><span class="n">GenerateExecutable</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">parameters</span><span class="p">.</span><span class="n">GenerateInMemory</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">parameters</span><span class="p">.</span><span class="n">TreatWarningsAsErrors</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
            

            <span class="n">parameters</span><span class="p">.</span><span class="n">ReferencedAssemblies</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"System.Windows.Forms.dll"</span><span class="p">);</span>
            <span class="n">parameters</span><span class="p">.</span><span class="n">ReferencedAssemblies</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"System.dll"</span><span class="p">);</span>
            <span class="n">parameters</span><span class="p">.</span><span class="n">ReferencedAssemblies</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"System.Drawing.dll"</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">appendContents</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">]);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// source-files</span>
            <span class="n">CompilerResults</span> <span class="n">result</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="nf">CompileAssemblyFromSource</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nf">getContents</span><span class="p">());</span>


            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">Errors</span><span class="p">.</span><span class="n">Count</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="n">CompilerError</span> <span class="n">er</span> <span class="k">in</span> <span class="n">result</span><span class="p">.</span><span class="n">Errors</span><span class="p">)</span>
                    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">er</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>

                <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">Assembly</span> <span class="n">assembly</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">CompiledAssembly</span><span class="p">;</span>
            <span class="n">MethodInfo</span> <span class="n">methodInfo</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="n">EntryPoint</span><span class="p">;</span>

            <span class="kt">object</span> <span class="n">entryPointInstance</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="nf">CreateInstance</span><span class="p">(</span><span class="n">methodInfo</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
            <span class="n">methodInfo</span><span class="p">.</span><span class="nf">Invoke</span><span class="p">(</span><span class="n">entryPointInstance</span><span class="p">,</span> <span class="k">null</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="proof-of-concept">Proof of concept</h2>

<p>Short video, before people start saying <em>it‚Äôs not working!!!</em>.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/q2Ip8A-8wu8" frameborder="0" allowfullscreen=""></iframe>

<p><a href="http://www.codeproject.com" rel="tag" style="display:none;">CodeProject</a></p>

:ET